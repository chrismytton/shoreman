<!DOCTYPE html>

<html>
<head>
  <title>shoreman.sh</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>shoreman.sh</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-meta">#!/bin/bash
</span></pre></div>
        
      
        
        <p><a href="https://github.com/chrismytton/shoreman">shoreman</a> is an
implementation of the <strong>Procfile</strong> format. Inspired by the original
<a href="http://ddollar.github.com/foreman/">foreman</a> tool for ruby.</p>

        
      
        
        <p>Make sure that any errors cause the script to exit immediately.</p>

        
          <div class='highlight'><pre><span class="hljs-built_in">set</span> -eo pipefail
[[ <span class="hljs-string">"<span class="hljs-variable">$TRACE</span>"</span> ]] &amp;&amp; <span class="hljs-built_in">set</span> -x</pre></div>
        
      
        
        <h2 id="usage">Usage</h2>

        
      
        
        <p>Usage message that is displayed when <code>--help</code> is given as an argument.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">usage</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: shoreman [procfile|Procfile] [envfile|.env]"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Run Procfiles using shell."</span>
  <span class="hljs-built_in">echo</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"The shoreman script reads commands from [procfile] and starts up the"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"processes that it describes."</span>
}</pre></div>
        
      
        
        <h2 id="logging">Logging</h2>

        
      
        
        <p>For logging we want to prefix each entry with the current time, as well
as the process name. This takes two arguments, the name of the process
with its index, and then reads data from stdin, formats it, and sends it
to stdout.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log</span></span>() {
  <span class="hljs-built_in">local</span> index=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
  <span class="hljs-built_in">local</span> format=<span class="hljs-string">"%s %s\t| %s"</span></pre></div>
        
      
        
        <p>We add colors when output is a terminal. <code>SHOREMAN_COLORS</code> can override it.</p>

        
          <div class='highlight'><pre>  <span class="hljs-keyword">if</span> [ -t 1 -o <span class="hljs-string">"<span class="hljs-variable">$SHOREMAN_COLORS</span>"</span> == <span class="hljs-string">"always"</span> ] \
     &amp;&amp; [ <span class="hljs-string">"<span class="hljs-variable">$SHOREMAN_COLORS</span>"</span> != <span class="hljs-string">"never"</span> ]; <span class="hljs-keyword">then</span></pre></div>
        
      
        
        <p>Bash colors start from 31 up to 37. We calculate what color the process
gets based on its index.</p>

        
          <div class='highlight'><pre>    <span class="hljs-built_in">local</span> color=<span class="hljs-string">"<span class="hljs-subst">$((31 + (index % 7)</span>))"</span>
    format=<span class="hljs-string">"\033[0;<span class="hljs-variable">${color}</span>m%s %s\t|\033[0m %s"</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> -r data
  <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"<span class="hljs-variable">$format</span>\n"</span> <span class="hljs-string">"<span class="hljs-subst">$(date +<span class="hljs-string">"%H:%M:%S"</span>)</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span>
  <span class="hljs-keyword">done</span>
}</pre></div>
        
      
        
        <h2 id="running-commands">Running commands</h2>

        
      
        
        <p>When a process is started, we want to keep track of its pid so we can
<code>kill</code> it when the parent process receives a signal, and so we can <code>wait</code>
for it to finish before exiting the parent process.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">store_pid</span></span>() {
  pids=<span class="hljs-string">"<span class="hljs-variable">$pids</span> <span class="hljs-variable">$1</span>"</span>
}</pre></div>
        
      
        
        <p>This starts a command asynchronously and stores its pid in a list for use
later on in the script.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">start_command</span></span>() {
  bash -c <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> 2&gt;&amp;1 | <span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$2</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$3</span>"</span> &amp;
  pid=<span class="hljs-string">"<span class="hljs-subst">$(jobs -p %%)</span>"</span>
  store_pid <span class="hljs-string">"<span class="hljs-variable">$pid</span>"</span>
}</pre></div>
        
      
        
        <h2 id="reading-the-env-file">Reading the .env file</h2>

        
      
        
        <p>The .env file needs to be a list of assignments like in a shell script.
Shell-style comments are permitted.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">load_env_file</span></span>() {
  <span class="hljs-built_in">local</span> env_file=<span class="hljs-variable">${1:-'.env'}</span></pre></div>
        
      
        
        <p>Set a default port before loading the .env file</p>

        
          <div class='highlight'><pre>  <span class="hljs-built_in">export</span> PORT=<span class="hljs-variable">${PORT:-5000}</span>

  <span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$env_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">export</span> $(grep <span class="hljs-string">"^[^#]*=.*"</span> <span class="hljs-string">"<span class="hljs-variable">$env_file</span>"</span> | xargs)
  <span class="hljs-keyword">fi</span>
}</pre></div>
        
      
        
        <h2 id="reading-the-procfile">Reading the Procfile</h2>

        
      
        
        <p>The Procfile needs to be parsed to extract the process names and commands.
The file is given on stdin, see the <code>&lt;</code> at the end of this while loop.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run_procfile</span></span>() {
  <span class="hljs-built_in">local</span> procfile=<span class="hljs-variable">${1:-'Procfile'}</span></pre></div>
        
      
        
        <p>We give each process an index to track its color. We start with 1,
because it corresponds to green which is easier on the eye than red (0).</p>

        
          <div class='highlight'><pre>  <span class="hljs-built_in">local</span> index=1
  <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line || [[ -n <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> ]]; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> ]] || [[ <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> == \<span class="hljs-comment">#* ]]; then continue; fi</span>
    <span class="hljs-built_in">local</span> name=<span class="hljs-string">"<span class="hljs-variable">${line%%:*}</span>"</span>
    <span class="hljs-built_in">local</span> <span class="hljs-built_in">command</span>=<span class="hljs-string">"<span class="hljs-variable">${line#*:[[:space:]]}</span>"</span>
    start_command <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${name}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$index</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"'<span class="hljs-variable">${command}</span>' started with pid <span class="hljs-variable">$pid</span>"</span> | <span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">${name}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$index</span>"</span>
    index=$((index + <span class="hljs-number">1</span>))
  <span class="hljs-keyword">done</span> &lt; <span class="hljs-string">"<span class="hljs-variable">$procfile</span>"</span>
}</pre></div>
        
      
        
        <h2 id="cleanup">Cleanup</h2>

        
      
        
        <p>When a <code>SIGINT</code>, <code>SIGTERM</code> or <code>EXIT</code> is received, this action is run, killing the
child processes. The sleep stops STDOUT from pouring over the prompt, it
should probably go at some point.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">onexit</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"SIGINT received"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"sending SIGTERM to all processes"</span>
  <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pids</span>
  sleep 1
}

<span class="hljs-function"><span class="hljs-title">main</span></span>() {
  <span class="hljs-built_in">local</span> procfile=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">local</span> env_file=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span></pre></div>
        
      
        
        <p>If the <code>--help</code> option is given, show the usage message and exit.</p>

        
          <div class='highlight'><pre>  expr -- <span class="hljs-string">"$*"</span> : <span class="hljs-string">".*--help"</span> &gt;/dev/null &amp;&amp; {
    usage
    <span class="hljs-built_in">exit</span> 0
  }

  load_env_file <span class="hljs-string">"<span class="hljs-variable">$env_file</span>"</span>
  run_procfile <span class="hljs-string">"<span class="hljs-variable">$procfile</span>"</span>

  <span class="hljs-built_in">trap</span> onexit INT TERM</pre></div>
        
      
        
        <p>Wait for the children to finish executing before exiting.</p>

        
          <div class='highlight'><pre>  <span class="hljs-built_in">wait</span> <span class="hljs-variable">$pids</span>
}

main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span></pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
